import themes from './themes';
import GamePlay from './GamePlay';
import GameStateService from './GameStateService';
import Swordsman from './characters/Swordsman';
import PositionedCharacter from './PositionedCharacter';
import Bowman from './characters/Bowman';
import Magician from './characters/Magician';
import Daemon from './characters/Daemon';
import Undead from './characters/Undead';
import Vampire from './characters/Vampire';
import { generateTeam, generatePositions } from './generators';
import { formatCharacterInfo, calcMoveRange } from './utils';
import cursors from './cursors';

/**
 * GameController - –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –û–Ω —Å–æ–∑–¥–∞–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Ü–∏—é GamePlay –∏ GameStateService,
 * –∞ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π
 * –∫ GamePlay –∏ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–ª–∏–∫–∏/–Ω–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ —è—á–µ–π–∫–∏
 */

export default class GameController {
  private gamePlay: GamePlay;
  private stateService: GameStateService;
  private playerTeam: PositionedCharacter[];
  private enemyTeam: PositionedCharacter[];
  // –ù–æ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ
  // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –≤—ã–±—Ä–∞–Ω (null),
  // –∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ —ç—Ç–æ –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç PositionedCharacter
  private selectedCharacter: PositionedCharacter | null = null;
  private level: number = 1; // –ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä—ã
  private isGameActive: boolean = true;
  private maxScore: number = 0;

  constructor(gamePlay: GamePlay, stateService: GameStateService) {
    console.log('GameController: Constructor called');
    this.gamePlay = gamePlay;
    this.stateService = stateService;
    this.playerTeam = [];
    this.enemyTeam = [];
  }

  init() {
    console.log('GameController: Starting init with theme: prairie');
    // TODO: add event listeners to gamePlay events
    // TODO: –¥–æ–±–∞–≤—å—Ç–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π gamePlay
    this.gamePlay.drawUi(themes.prairie);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    this.gamePlay.addCellEnterListener((index: number) =>
      this.onCellEnter(index)
    );
    this.gamePlay.addCellLeaveListener((index: number) =>
      this.onCellLeave(index)
    );

    this.gamePlay.addCellClickListener((index: number) =>
      this.onCellClick(index)
    );

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è New Game
    this.gamePlay.addNewGameListener(() => this.onNewGame());

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
    const playerTypes = [Swordsman, Bowman, Magician];
    const enemyTypes = [Daemon, Undead, Vampire];
    const playerTeam = generateTeam(playerTypes, 1, 2);
    const enemyTeam = generateTeam(enemyTypes, 1, 2);

    // –ü–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞ (—Å—Ç–æ–ª–±—Ü—ã 1 –∏ 2: 0, 1, 8, 9, 16, 17, ...),
    const playerPositions = [];
    for (let row = 0; row < 8; row++) {
      playerPositions.push(row * 8, row * 8 + 1);
    }
    console.log(playerPositions);

    // –ü–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Ä–∞–≥–∞ (—Å—Ç–æ–ª–±—Ü—ã 7 –∏ 8: 6, 7, 14, 15, 22, 23, ...)
    const enemyPositions = [];
    for (let row = 0; row < 8; row++) {
      enemyPositions.push(row * 8 + 6, row * 8 + 7);
    }
    console.log(enemyPositions);

    // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
    this.playerTeam = generatePositions(
      playerTeam.getCharacters(),
      playerPositions
    );

    this.enemyTeam = generatePositions(
      enemyTeam.getCharacters(),
      enemyPositions
    );

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    this.gamePlay.redrawPositions([...this.playerTeam, ...this.enemyTeam]);
    console.log('GameController: UI drawn');

    // TODO: load saved stated from stateService
    // TODO: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ stateService

    // –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ—Ä–¥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    const savedScore = this.stateService.storage.getItem('GameScore');
    if (savedScore) {
      this.maxScore = Number(savedScore);
      console.log('GameController: –ó–∞–≥—Ä—É–∂–µ–Ω —Ä–µ–∫–æ—Ä–¥:', this.maxScore);
    }

    // –¢–µ—Å—Ç: —Å–æ–∑–¥–∞—ë–º Swordsman –∏ —Ä–∞–∑–º–µ—â–∞–µ–º –Ω–∞ –ø–æ–ª–µ
    // const swordsman = new Swordsman(1);
    // const positionedSwordsman = new PositionedCharacter(swordsman, 0); // –ü–æ–∑–∏—Ü–∏—è 0 (–≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª)
    // this.gamePlay.redrawPositions([positionedSwordsman]); // –†–∏—Å—É–µ–º –Ω–∞ –ø–æ–ª–µ
  }

  private getMoveRange(character: PositionedCharacter): number {
    if (
      character.character instanceof Swordsman ||
      character.character instanceof Undead
    ) {
      return 4;
    }
    if (
      character.character instanceof Bowman ||
      character.character instanceof Vampire
    ) {
      return 2;
    }
    if (
      character.character instanceof Magician ||
      character.character instanceof Daemon
    ) {
      return 1;
    }
    return 0; // –ù–∞ —Å–ª—É—á–∞–π –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
  }

  private getAttackRange(character: PositionedCharacter): number {
    if (
      character.character instanceof Swordsman ||
      character.character instanceof Undead
    ) {
      return 1;
    }
    if (
      character.character instanceof Bowman ||
      character.character instanceof Vampire
    ) {
      return 2;
    }
    if (
      character.character instanceof Magician ||
      character.character instanceof Daemon
    ) {
      return 4;
    }
    return 0;
  }

  private calcScore(): number {
    // –°—É–º–º–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–≥—Ä–æ–∫–∞
    const healthScore = this.playerTeam.reduce(
      (sum, char) => sum + char.character.health,
      0
    );
    // –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å. –£—Ä–æ–≤–µ–Ω—å 1 –¥–∞–µ—Ç x1, –£—Ä–æ–≤–µ–Ω—å 2 –¥–∞–µ—Ç x2 –∏ —Ç.–¥.
    return healthScore * this.level;
  }

  /**
   * –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–±–Ω—É–ª–µ–Ω–∏—è
   * –ø—Ä–∏ –ü–æ–±–µ–¥–µ (–∫–æ–≥–¥–∞ –∫–æ–º–∞–Ω–¥–∞ —É–∂–µ –æ—á–∏—â–µ–Ω–∞).
   */
  private handleGameOver(finalScore?: number) {
    // 1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á–µ—Ç
    // –ï—Å–ª–∏ finalScore –ø–µ—Ä–µ–¥–∞–Ω (–¥–ª—è –ü–æ–±–µ–¥—ã), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ. –ò–Ω–∞—á–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π.
    const currentScore = finalScore !== undefined ? finalScore : this.calcScore();

    if (currentScore > this.maxScore) {
      this.maxScore = currentScore;
      GamePlay.showMessage(`–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: ${this.maxScore}!`);
    }

    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (GameScore - –Ω–æ–≤—ã–π –∫–ª—é—á)
    this.stateService.storage.setItem('GameScore', String(this.maxScore));

    // 3. –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–≥—Ä—É
    this.isGameActive = false;
    this.gamePlay.blockGame();
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å —Å—á–µ—Ç –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –¥–∞–∂–µ –ø—Ä–∏ –ü–æ–±–µ–¥–µ, –≥–¥–µ –∫–æ–º–∞–Ω–¥–∞ –æ—á–∏—â–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ.
    GamePlay.showMessage(
      `–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞. –í–∞—à —Å—á–µ—Ç: ${currentScore}. –†–µ–∫–æ—Ä–¥: ${this.maxScore}.`
    );
  }

  onNewGame() {
    // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
    this.level = 1;
    this.isGameActive = true;
    this.selectedCharacter = null;
    this.playerTeam = [];
    this.enemyTeam = [];

    // 2. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –∏ —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫
    this.gamePlay.unblockGame();
    for (let i = 0; i < 64; i++) {
      this.gamePlay.deselectCell(i);
    }

    // 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤–æ–µ –ø–æ–ª–µ –∏ –∫–æ–º–∞–Ω–¥—ã
    // –ü—Ä–∏ —ç—Ç–æ–º –≤–∞–∂–Ω–æ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å maxScore
    this.init();
  }

  // –ú–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è,
  // –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∫–ª–∏–∫–∞–µ—Ç –ø–æ —è—á–µ–π–∫–µ
  async onCellClick(index: number) {
    if (!this.isGameActive) {
      GamePlay.showError('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "New Game"');
      return;
    }

    // console.log('GameController: Cell clicked');
    const clickedCharacter = [...this.playerTeam, ...this.enemyTeam].find(
      (p) => p.position === index
    );
    if (clickedCharacter) {
      if (this.playerTeam.includes(clickedCharacter)) {
        // console.log('GameController: –ö–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–≥—Ä–æ–∫–∞');
        // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω –¥—Ä—É–≥–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ - —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        if (this.selectedCharacter) {
          this.gamePlay.deselectCell(this.selectedCharacter.position);
        }
        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        this.selectedCharacter = clickedCharacter;
        // –í—ã–¥–µ–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        this.gamePlay.selectCell(index);
        // –ú–µ–Ω—è–µ—Ç –∫—É—Ä—Å–æ—Ä –Ω–∞ pointer
        this.gamePlay.setCursor(cursors.pointer);
      } else if (
        this.selectedCharacter &&
        this.enemyTeam.includes(clickedCharacter)
      ) {
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –≤—Ä–∞–≥–∞ –∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂
        const attackRange = this.getAttackRange(this.selectedCharacter);
        const allowedAttacks = calcMoveRange(
          this.selectedCharacter.position,
          attackRange
        );
        // –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –∞—Ç–∞–∫–∏
        if (allowedAttacks.includes(index)) {
          // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
          const calculatedDamage = Math.max(
            this.selectedCharacter.character.getAttack() -
              clickedCharacter.character.getDefence(),
            this.selectedCharacter.character.getAttack() * 0.1
          );
          // –û–∫—Ä—É–≥–ª—è–µ–º —É—Ä–æ–Ω –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞, –º–∏–Ω–∏–º—É–º 1
          const damage = Math.max(1, Math.round(calculatedDamage));
          
          // –ù–∞–Ω–æ—Å–∏–º —É—Ä–æ–Ω
          clickedCharacter.character.health -= damage;
          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–Ω–∏–∑—É –Ω—É–ª–µ–º (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã)
          clickedCharacter.character.health = Math.max(0, clickedCharacter.character.health);

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Ä–æ–Ω–∞. –¢–µ–ø–µ—Ä—å damage —É–∂–µ –æ–∫—Ä—É–≥–ª–µ–Ω–æ.
          await this.gamePlay.showDamage(index, damage);
          
          // –ï—Å–ª–∏ –≤—Ä–∞–≥ –º—ë—Ä—Ç–≤ - —É–±–∏—Ä–∞–µ–º –∏–∑ –∫–æ–º–∞–Ω–¥—ã
          if (clickedCharacter.character.health <= 0) {
            this.enemyTeam = this.enemyTeam.filter(
              (enemy) => enemy !== clickedCharacter
            );
          }
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          if (this.selectedCharacter) {
            this.gamePlay.deselectCell(this.selectedCharacter.position);
          }
          this.gamePlay.deselectCell(index);
          this.selectedCharacter = null; // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          this.gamePlay.setCursor(cursors.auto);

          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ
          this.gamePlay.redrawPositions([
            ...this.playerTeam,
            ...this.enemyTeam,
          ]);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
          if (this.enemyTeam.length === 0) {
            // –ü–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –≤—Å–µ—Ö –≤—ã–∂–∏–≤—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            for (const player of this.playerTeam) {
              player.character.levelUp();
            }
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
            this.startNewLevel();
          } else {
            // –•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            await this.makeEnemyTurn();
          }
        } else {
          // –ï—Å–ª–∏ –≤—Ä–∞–≥ –≤–Ω–µ —Ä–∞–¥–∏—É—Å–∞ –∞—Ç–∞–∫–∏
          GamePlay.showError('–ù–µ–ª—å–∑—è –∞—Ç–∞–∫–æ–≤–∞—Ç—å ‚Äî –≤—Ä–∞–≥ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ');
        }
      } else {
        // –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –≤—Ä–∞–≥–∞, –Ω–æ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        GamePlay.showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
      }
    } else {
      if (this.selectedCharacter) {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ç—É–¥–∞ –ø–æ–π—Ç–∏

        const moveRange = this.getMoveRange(this.selectedCharacter); // –î–∞–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞

        const allowedMoves = calcMoveRange(
          this.selectedCharacter.position,
          moveRange
        ); // –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª–µ—Ç–∫–∏

        if (allowedMoves.includes(index)) {
          // –¢–æ–≥–¥–∞ –º—ã –ø–µ—Ä–µ–º–µ—â–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
          const oldPosition = this.selectedCharacter.position; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–∑–∏—Ü–∏—é
          this.selectedCharacter.position = index; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
          this.gamePlay.deselectCell(oldPosition); // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–π –∫–ª–µ—Ç–∫–∏
          this.gamePlay.deselectCell(index); // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π –∫–ª–µ—Ç–∫–∏
          this.selectedCharacter = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
          this.gamePlay.redrawPositions([
            ...this.playerTeam,
            ...this.enemyTeam,
          ]); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ
          // –•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
          await this.makeEnemyTurn();
        } else {
          // –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è –ø–æ–π—Ç–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          GamePlay.showError('–°—é–¥–∞ –ø–æ–π—Ç–∏ –Ω–µ–ª—å–∑—è');
        }
      }
    }
  }

  private getPlayerPositions(): number[] {
    const positions: number[] = [];
    for (let row = 0; row < 8; row++) {
      positions.push(row * 8, row * 8 + 1); // –°—Ç–æ–ª–±—Ü—ã 1 –∏ 2
    }
    return positions;
  }

  private getEnemyPositions(): number[] {
    const positions: number[] = [];
    for (let row = 0; row < 8; row++) {
      positions.push(row * 8 + 6, row * 8 + 7); // –°—Ç–æ–ª–±—Ü—ã 7 –∏ 8
    }
    return positions;
  }

  private startNewLevel(): void {
    this.level += 1;

    let theme: string;
    if (this.level === 1) theme = themes.prairie;
    else if (this.level === 2) theme = themes.desert;
    else if (this.level === 3) theme = themes.arctic;
    else if (this.level === 4) theme = themes.mountain;
    else {
      // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫–æ–º–∞–Ω–¥
      const finalScore = this.calcScore();

      GamePlay.showMessage('–í—ã –ø–æ–±–µ–¥–∏–ª–∏! –í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã.');
      this.playerTeam = [];
      this.enemyTeam = [];
      this.gamePlay.redrawPositions([]);
      this.handleGameOver(finalScore); // –ü–µ—Ä–µ–¥–∞–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π —Å—á–µ—Ç
      return;
    }

    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ç–µ–º—É
    this.gamePlay.drawUi(theme);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ù–û–í–´–• –≤—Ä–∞–≥–æ–≤
    const enemyTypes = [Daemon, Undead, Vampire];
    const newEnemyCharacters = generateTeam(
      enemyTypes,
      this.level,
      this.playerTeam.length // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–∞–≥–æ–≤ —Ä–∞–≤–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤—ã–∂–∏–≤—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
    ).getCharacters();
    this.enemyTeam = generatePositions(
      newEnemyCharacters, // <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Character[]
      this.getEnemyPositions()
    );

    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –í–´–ñ–ò–í–®–ò–• –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏,
    // —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö levelUp()
    const playerCharacters = this.playerTeam.map((pc) => pc.character); // –ü–æ–ª—É—á–∞–µ–º Character[] –∏–∑ PositionedCharacter[]
    this.playerTeam = generatePositions(
      playerCharacters, // <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ levelUp
      this.getPlayerPositions()
    );

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ
    this.gamePlay.redrawPositions([...this.playerTeam, ...this.enemyTeam]);

    // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ
    GamePlay.showMessage(`–£—Ä–æ–≤–µ–Ω—å ${this.level} –Ω–∞—á–∞—Ç!`);
  }

  onCellEnter(index: number) {
    // TODO: show tooltip
    // TODO: –ø–æ–∫–∞–∑–∞—Ç—å tooltip
    const character = [...this.playerTeam, ...this.enemyTeam].find(
      (p) => p.position === index
    );
    if (character) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
      const level = character.character.getLevel();
      const attack = character.character.getAttack();
      const defence = character.character.getDefence();
      const health = character.character.health;
      const message = formatCharacterInfo`üéñ${level} ‚öî${attack} üõ°${defence} ‚ù§${health}`;
      this.gamePlay.showCellTooltip(message, index);

      // –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–≥—Ä–æ–∫–∞ –∏ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –µ–≥–æ
      if (this.selectedCharacter) {
        const attackRange = this.getAttackRange(this.selectedCharacter);
        const allowedAttacks = calcMoveRange(
          this.selectedCharacter.position,
          attackRange
        );
        if (
          this.enemyTeam.includes(character) &&
          allowedAttacks.includes(index)
        ) {
          this.gamePlay.selectCell(index, 'red');
          this.gamePlay.setCursor(cursors.crosshair);
        } else if (this.playerTeam.includes(character)) {
          this.gamePlay.setCursor(cursors.pointer);
        } else {
          this.gamePlay.setCursor(cursors.notallowed);
        }
      } else {
        if (this.playerTeam.includes(character)) {
          this.gamePlay.setCursor(cursors.pointer);
        } else {
          this.gamePlay.setCursor(cursors.notallowed);
        }
      }
    } else {
      if (this.selectedCharacter) {
        const moveRange = this.getMoveRange(this.selectedCharacter);
        const allowedMoves = calcMoveRange(
          this.selectedCharacter.position,
          moveRange
        );
        if (allowedMoves.includes(index)) {
          this.gamePlay.selectCell(index, 'green');
          this.gamePlay.setCursor(cursors.pointer);
        } else {
          this.gamePlay.setCursor(cursors.notallowed);
        }
      } else {
        this.gamePlay.setCursor(cursors.auto);
      }
    }
  }

  onCellLeave(index: number) {
    // TODO: hide tooltip
    // TODO: —É–±—Ä–∞—Ç—å tooltip
    this.gamePlay.hideCellTooltip(index);
    if (!this.selectedCharacter || this.selectedCharacter.position !== index) {
      this.gamePlay.deselectCell(index);
    }
    this.gamePlay.setCursor(cursors.auto);
  }

  private async makeEnemyTurn() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∂–∏–≤—ã–µ –≤—Ä–∞–≥–∏
    if (this.enemyTeam.length === 0) {
      GamePlay.showMessage('–í—ã –ø–æ–±–µ–¥–∏–ª–∏!');
      return;
    }

    // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∂–∏–≤—ã—Ö —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤
    const aliveEnemies = this.enemyTeam.filter(
      (enemy) => enemy.character.health > 0
    );
    if (aliveEnemies.length === 0) {
      GamePlay.showMessage('–í—ã –ø–æ–±–µ–¥–∏–ª–∏!');
      return;
    }
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
    const enemy = aliveEnemies[Math.floor(Math.random() * aliveEnemies.length)];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–≥—Ä–æ–∫–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
    const attackRange = this.getAttackRange(enemy);
    const allowedAttacks = calcMoveRange(enemy.position, attackRange);
    const attackablePlayers = this.playerTeam.filter(
      (player) =>
        allowedAttacks.includes(player.position) && player.character.health > 0
    );
    // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏
    if (attackablePlayers.length > 0) {
      // –ê—Ç–∞–∫–∞: –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
      const targetPlayer =
        attackablePlayers[Math.floor(Math.random() * attackablePlayers.length)];
      // –í—ã–ø–æ–ª–Ω—è–µ–º –∞—Ç–∞–∫—É
      // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
      const calculatedDamage = Math.max(
        enemy.character.getAttack() - targetPlayer.character.getDefence(),
        enemy.character.getAttack() * 0.1
      );
      // –û–∫—Ä—É–≥–ª—è–µ–º —É—Ä–æ–Ω –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞, –º–∏–Ω–∏–º—É–º 1
      const damage = Math.max(1, Math.round(calculatedDamage));
      
      targetPlayer.character.health -= damage;
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–Ω–∏–∑—É –Ω—É–ª–µ–º
      targetPlayer.character.health = Math.max(0, targetPlayer.character.health);

      await this.gamePlay.showDamage(targetPlayer.position, damage);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∂–∏–≤ –ª–∏ –∏–≥—Ä–æ–∫
      if (targetPlayer.character.health <= 0) {
        this.playerTeam = this.playerTeam.filter(
          (player) => player !== targetPlayer
        );
      }
    } else {
      // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: –Ω–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞

      // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞
      let nearestPlayer: PositionedCharacter | null = null;

      // –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
      let minDistance = Infinity;

      for (const player of this.playerTeam) {
        if (player.character.health > 0) {
          // –≤—ã–±–∏—Ä–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏–∑ –¥–≤—É—Ö –∑–Ω–∞—á–µ–Ω–∏–π,
          // —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞–Ω—Ö—ç—Ç—Ç–µ–Ω—Å–∫–æ–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
          // (–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –∫–ª–µ—Ç–∫–∞–º)
          const distance = Math.max(
            Math.abs(
              Math.floor(player.position / 8) - Math.floor(enemy.position / 8)
            ),
            Math.abs((player.position % 8) - (enemy.position % 8))
          );
          if (distance < minDistance) {
            minDistance = distance;
            nearestPlayer = player;
          }
        }
      }

      if (nearestPlayer) {
        // –ù–∞—Ö–æ–¥–∏–º –∫–ª–µ—Ç–∫–∏, –∫—É–¥–∞ –º–æ–∂–Ω–æ –ø–æ–π—Ç–∏
        const moveRange = this.getMoveRange(enemy);
        const allowedMoves = calcMoveRange(enemy.position, moveRange);
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
        const freeMoves = allowedMoves.filter((move) => this.isCellFree(move));
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–ª–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–º–µ–Ω—å—à–∞—é—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∏–≥—Ä–æ–∫–∞
        let bestMove: number | null = null;
        let bestDistance = minDistance;
        for (const move of freeMoves) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º freeMoves –≤–º–µ—Å—Ç–æ allowedMoves
          const newDistance = Math.max(
            Math.abs(
              Math.floor(nearestPlayer.position / 8) - Math.floor(move / 8)
            ),
            Math.abs((nearestPlayer.position % 8) - (move % 8))
          );
          if (newDistance < bestDistance) {
            bestDistance = newDistance;
            bestMove = move;
          }
        }
        if (bestMove !== null) {
          enemy.position = bestMove;
        }
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∏–≥—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ —Ö–æ–¥–∞ AI)
    if (
      this.playerTeam.length === 0 ||
      this.playerTeam.every((player) => player.character.health <= 0)
    ) {
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ –ø–µ—Ä–µ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º (—á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ —É–≤–∏–¥–µ–ª —Å–º–µ—Ä—Ç—å)
      this.gamePlay.redrawPositions([...this.playerTeam, ...this.enemyTeam]);
      // –ü—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏ calcScore() –≤–µ—Ä–Ω–µ—Ç 0, —Ç–∞–∫ –∫–∞–∫ –∑–¥–æ—Ä–æ–≤—å–µ = 0.
      this.handleGameOver(); // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
      return;
    }

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ (–µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –ø–æ—Ä–∞–∂–µ–Ω–∏—è)
    this.gamePlay.redrawPositions([...this.playerTeam, ...this.enemyTeam]);
  }

  // –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏
  private isCellFree(index: number): boolean {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –Ω–∞ –∫–ª–µ—Ç–∫–µ –∫–æ–≥–æ-—Ç–æ –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ –∏–ª–∏ –≤—Ä–∞–≥–æ–≤
    const occupied = [...this.playerTeam, ...this.enemyTeam].some(
      (char) => char.position === index
    );
    return !occupied; // true, –µ—Å–ª–∏ —Å–≤–æ–±–æ–¥–Ω–∞
  }
}
